#!/usr/bin/env bash
cd "$(dirname "${BASH_SOURCE[0]}")" || {
  echo "Failed to change to script's directory!(${BASH_SOURCE[0]})"
  exit 1
}
source common.sh || {
  echo "Failed to load common.sh"
  exit 1
}

# DEFAULTS may be overridden by calling environment.
readonly GRADLE="${GRADLE:-gradle}"
readonly GRADLEW="${GRADLEW:-gradlew}"
readonly GRADLE_BUILDFILE="${GRADLE_BUILDFILE:-build.gradle}"
readonly GRADLE_KTS_BUILDFILE="${GRADLE_KTS_BUILDFILE:-build.gradle.kts}"

lookup() {
  local file="${1}"
  local curr_path="${2}"
  [[ -z "${curr_path}" ]] && curr_path="${PWD}"

  # Search recursively upwards for file.
  until [[ "${curr_path}" == "/" ]]; do
    if [[ -e "${curr_path}/${file}" ]]; then
      echo "${curr_path}/${file}"
      break
    else
      curr_path=$(dirname "${curr_path}")
    fi
  done
}

__GRADLE_HOME__=$(mktemp -d)
trap 'rm -rf ${__GRADLE_HOME__}' EXIT
#Embedded Gradle Wrapper
function __gradlew__() {
  java -classpath /opt/gng/gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain \
    -q --no-daemon -g "${__GRADLE_HOME__}" -I "/opt/gng/gradle/init.gradle" "$@"
}

select_gradle() {
  local dir="${1}"
  # Use project's gradlew if found.
  local gradlew
  gradlew=$(lookup "${GRADLEW}" "${dir}")
  if [[ -z "${gradlew}" ]]; then
    err "No ${GRADLEW} set up for this project; Please use 'gng --bootstrap' installing a Gradle Wrapper'."
    return 1
  else
    echo "${gradlew}"
    return 0
  fi

  return 1
}

GWO_AGENT="${HOME}/.gradle/gwo-agent.jar"
GWO_AGENT_CFG="${HOME}/.gradle/gwo-agent.cfg"
gradle() {
  local gradle
  gradle=$(select_gradle "${PWD}")
  # Say what we are gonna do, then do it.
  info "Using gradle at '${gradle}' to run"
  if [ -f "${GWO_AGENT}" ] && [ -f "${GWO_AGENT_CFG}" ]; then
    local -a arr
    while IFS='=' read -r k v; do
      arr["$k"]="$v"
    done <"${GWO_AGENT_CFG}"
    local url="${arr['url']}"
    if [ -z "${url}" ]; then
      err "Missing url configuration in ${GWO_AGENT_CFG}"
    else
      info "Replacing gradlew distributionUrl with ${url} using gwo-agent."
      export GRADLE_OPTS="${GRADLE_OPTS} -javaagent:${GWO_AGENT}=distributionUrl~=@https://services.gradle.org/distributions@${url}/@"
    fi
  fi
  "${gradle}" "$@"
}

function install() {
  local saved_params=()
  local gradle_version="latest"
  local distType="bin"
  if [[ $# -gt 0 ]]; then
    gradle_version="$1"
    shift
  fi
  if [[ $# -gt 0 ]]; then
    distType="$1"
    shift
  fi
  case "${distType}" in
  "all" | "bin") ;;

  *)
    die "wrong distType: ${distType}(all, bin)"
    ;;
  esac

  if [[ "${gradle_version}" == "latest" ]]; then
    info "Fetching the latest Gradle version"
    local gradle_version_info
    gradle_version_info=$(curl -sSL "https://services.gradle.org/versions/current")
    gradle_version=$(echo "$gradle_version_info" | python -c "import json,sys;obj=json.load(sys.stdin);print obj['version'];")
  fi

  info "Running the embedded wrapper ..."
  __gradlew__ -Pver="${gradle_version}" -PdistType="${distType}" wrapper
  # Clean the temporary cache dir
  rm -rf .gradle
}

#Support `gradle init` behavior
init() {
  info "Initializing a Gradle project ..."
  local gradle
  gradle=$(select_gradle)
  if [[ -z ${gradle} ]]; then
    install
    gradle=$(select_gradle)
  fi
  "${gradle}" "$@"
}

case "$1" in
--bootstrap)
  command -v java >/dev/null 2>&1 || die "ERROR: no 'java' command could be found in your PATH."
  shift
  install "$@"
  ;;
init)
  init "$@"
  ;;
*)
  gradle "$@"
  ;;
esac
